
# Brace UMD
### A unified module definition script to support modules written with Requirejs and AMDefine syntax while working seamlessly with the r.js optimizer and the native global Object.

[![Build status](https://ci.appveyor.com/api/projects/status/j9w4v3romfw971y9/branch/master?svg=true)](https://ci.appveyor.com/project/restarian/brace-umd/branch/master) [![Build Status](https://travis-ci.org/restarian/brace_umd.svg?branch=master)](https://travis-ci.org/restarian/brace_umd) [![Downloads](https://img.shields.io/npm/dm/brace_umd.svg?svg=true)](https://npmjs.org/package/brace_umd)

------

### Document pages
* [(Re)building the source](https://github.com/restarian/brace_umd/blob/master/doc/build.md)
* [Use with r.js](https://github.com/restarian/brace_umd/blob/master/doc/optimizer.md)
* [Specification](https://github.com/restarian/brace_umd/blob/master/doc/specification.md)
* [Licenses](https://github.com/restarian/brace_umd/blob/master/doc/license.md)
* [Todo](https://github.com/restarian/brace_umd/blob/master/doc/todo.md)

----

[![Bash on Windows](https://raw.githubusercontent.com/restarian/brace_umd/master/doc/image/ubuntu_windows_logo.png)](https://github.com/Microsoft/BashOnWindows)

**Author: Robert Steckroth, Bustout**

**License: MIT**

**Bonuses:**
* well commented, professional code
* thoroughly documented
* vast and deep unit tests on multiple platforms

**Caveats:**
  * Requires nodejs version 5 or greater
  * An id string must be used in order to have native global Object support in environments other than nodejs. Otherwise, it can be omitted to supply only RequireJs, AMDefine and r.js support.


**Below are some ways to use the UMD. The following code works in nodejs or the browser:**
```javascript
// A pretty output of the minified script used below

/* Generated by Brace_UMD 0.2.8 */
(function() {
    var e = {
        requirejs: typeof requirejs !== 'undefined' && requirejs || undefined,
        define: typeof define !== 'undefined' && define || undefined,
        module: typeof module !== 'undefined' && module || undefined,
        _factory: arguments[0] || undefined,
        support: {
            requirejs: true,
            define: true,
            factory: true
        },
        force_type: arguments[0] && arguments[0].force_type || arguments[1] && arguments[1].force_type,
        rjs_properties: [ 'config', 'nextTick', 'version', 'jsExtRegExp', 'isBrowser', 's', 'toUrl', 'undef', 'defined', 'specified', 'onError', 'createNode', 'load', 'exec' ],
        rjs: function() {
            if (e.module && !e.requirejs) try {
                e.requirejs = e.module.require('requirejs');
                for (var r in e.requirejs) e.rjs[r] = e.requirejs[r];
            } catch (e) {
                console.log(e.message);
            }
            var o = e.requirejs || e.factory;
            o.apply(o.prototype, arguments);
        }
    };
    for (var r in e.rjs_properties) e.rjs.__defineGetter__(e.rjs_properties[r], function(r) {
        if (e.module) try {
            e.requirejs = e.module.require('requirejs');
            for (var o in e.requirejs) e.rjs[o] = e.requirejs[o];
        } catch (e) {
            console.log(e.message);
        }
        console.log(r);
        return e.requirejs[r];
    }.bind(null, e.rjs_properties[r]));
    e.factory = e._factory && function(e, r, o, i) {
        if (e && e.constructor === Array && this.module) {
            var n = e, t = dependency, s = o, f = i;
            i = f;
            o = s;
            dependency = n;
            e = this.module.filenmame;
        }
        console.log('Using factory for module', e);
        if (typeof e !== 'string') console.log('The global native Object is attempted to be used but the module does not supply an id parameter. Skipping loading of the module.'); else if (r.every(function(r, o) {
            return r in this.factory || !!console.log('The dependency', r, 'is not loaded into the factory yet. Skipping loading of the module', e);
        }, this)) this._factory[e] = o.apply(o.prototype, r.map(function(e, r) {
            return this._factory[e];
        }, this));
    }.bind(e);
    if (e.force_type) if (!(e.force_type in e.support)) {
        console.log('The forced type', e.force_type, 'specified as an option is not supported by Brace UMD. Supported types are', Object.keys(e.support));
    } else if (!e[e.force_type]) {
        console.log('The forced type', e.force_type, 'is not available.');
    } else {
        console.log('Forcing use of the definition type', e.force_type);
        e.requirejs = e.define = e.factory = e[e.force_type];
    }
    var define = e.define || function() {
        if (e.module && !e.define) try {
            e.define = e.module.require('amdefine')(e.module);
        } catch (e) {
            console.log(e.message);
        }
        var r = e.define || e.factory;
        r.apply(r.prototype, arguments);
    };
    var requirejs = e.requirejs || e.rjs;
    define('aa', [ 'bb' ], function() {
        console.log('Init aa');
        return {
            id: 'aa'
        };
    });
    define('bb', [], function() {
        console.log('Init bb');
        return {
            id: 'aa'
        };
    });
    requirejs.config({});
    requirejs([ 'require' ], function(require) {
        console.log('Init main', __filename);
        return {
            aa: 'require("aa")',
            bb: 'require("bb")'
        };
    });
    define(function(require) {
        console.log('Init main', __filename);
        return {
            aa: require('aa'),
            bb: require('bb')
        };
    });
}(this))


// The same script as above but with minified code.

(function(o){var e=void 0!==requirejs&&requirejs||void 0,t=void 0!==define&&define||void 0,r=void 0!==require&&require||module&&module.require.bind(module)||void 0,p=function(){var o=Array.prototype.slice.call(arguments);o.shift();arguments[0].apply(arguments[0].prototype,o)},define=function(){var o=Array.prototype.slice.call(arguments);o.unshift(t||"object"==typeof module&&module.exports&&n||i);p.apply(p.prototype,o)},require=function(){var o=Array.prototype.slice.call(arguments);o.unshift(r||i);p.apply(p.prototype,o)},requirejs=function(){var o=Array.prototype.slice.call(arguments);o.unshift(e||"object"==typeof module&&module.exports&&n||i);p.apply(p.prototype,o)},n=function(o,e,t,p){e=e||[];module.exports=t.apply(t.prototype,e.map(function(o,e){return r(o)}))},i=function(e,t,r,p){if(e&&e.constructor===Array){var n=p;p=r;r=t;t=e;e=__filename.replace(/.*[\\,\/]/g,"")}"string"!=typeof e?console.log("The global native Object needs to be used but the module id parameter is not available."):t.every(function(t,r){return t in o||!!console.log("The dependency",t,"is not loaded into the factory yet. Skipping loading of the module",e)})&&(o[e]=r.apply(r,t.map(function(e,t){return o[e]})))}

  define("my_mod", [], function() {
    id = "my_mod"
    return {id: this.id}
  })

}(this))

```

**The script below was generated via _r.js -o require_build.js_ script in the requirejs_wrapped example. It works as a module definition on all platforms regardless of what libraries are available.**

```javascript
!function(o) {
    var e = l || void 0, t = p || void 0, n = r || void 0, l = function() {
        var t = Array.prototype.slice.call(arguments);
        t.unshift(e || "object" == typeof module && module.exports && i || o);
        a.apply(a.prototype, t);
    }, r = function() {
        var e = Array.prototype.slice.call(arguments);
        e.unshift(n || o);
        a.apply(a.prototype, e);
    }, p = function() {
        var e = Array.prototype.slice.call(arguments);
        e.unshift(t || "object" == typeof module && module.exports && i || o);
        a.apply(a.prototype, e);
    }, i = function(o, e, l, r) {
        e = e || [];
        module.exports = l.apply(l.prototype, e.map(function(o, e) {
            return (t || n)(o);
        }));
    }, o = function(e, t, n, l) {
        "string" != typeof e ? console.warn("The global native Object needs to be used but the module id parameter is not available.") : t.every(function(t, n) {
            return t in o || !!console.warn("The dependency", t, "is not loaded into the factory yet. Skipping loading of the module", e);
        }) && (o[e] = n.apply(n, t.map(function(e, t) {
            return o[e];
        })));
    }, a = function() {
        var o = Array.prototype.slice.call(arguments);
        o.shift();
        arguments[0].apply(arguments[0].prototype, o);
    };
    l("another_module", [ "another_module" ], function(o) {
        console.log("module init");
        return {
            cool: "joes"
        };
    });
    l("example_module", [ "another_module" ], function(o) {
        console.log("odule init");
        return {
            cool: "joes"
        };
    });
}(this);
```
